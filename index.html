<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Seguridad con M√°quinas ‚Äì Juegos</title>
  <style>
    body { margin:0; font-family: system-ui, Arial; background:#0f172a; color:#e5e7eb; }
    header { background:#111827ee; padding:12px; position:sticky; top:0; z-index:10; }
    h1 { margin:0; font-size:1.4rem; }
    .tabs { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
  .tab { border:none; padding:10px 12px; border-radius:12px; background:#1f2937; color:#e5e7eb; cursor:pointer; }
    .tab[aria-selected="true"] { background:#22c55e; color:#081016; }
    .grid { display:grid; gap:14px; margin:16px; }
    .card { background:#111827; border:1px solid #333; border-radius:16px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.4); }
    .pill { display:inline-block; padding:.2rem .5rem; border:1px solid #444; border-radius:999px; font-size:.8rem; }
    /* Memorama */
    .board { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; max-width:500px; }
    .tile { position:relative; aspect-ratio:1/1; border-radius:14px; background:#0b1220; border:1px solid #263044; display:grid; place-items:center; cursor:pointer; transform-style:preserve-3d; transition:transform .35s; }
    .tile.flip { transform:rotateY(180deg); }
    .face { position:absolute; inset:0; display:grid; place-items:center; backface-visibility:hidden; border-radius:14px; }
    .front { background:#0f1a30; }
    .back { transform:rotateY(180deg); background:#1f2937; }
    .back img { width:60%; height:60%; object-fit:contain; }
    /* Imagen de riesgos */
    .scene img { max-width:100%; border-radius:12px; border:1px solid #444; }
    input[type="text"] { padding:10px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; min-width:220px; }
    button.primary { padding:10px 14px; border-radius:12px; border:0; background:#22c55e; color:#081016; font-weight:700; cursor:pointer; }
  </style>
</head>
<body>
<header>
  <h1>Seguridad con M√°quinas ‚Äì Juegos</h1>
  <div class="tabs">
    <button class="tab" aria-selected="true" data-target="#memoria">üÉè Memorama</button>
    <button class="tab" aria-selected="false" data-target="#riesgos">üöß Riesgos</button>
    <button class="tab" aria-selected="false" data-target="#trivia">‚ùì Trivia</button>
  </div>
</header>

<main class="grid">
  <!-- Identidad del jugador -->
  <section class="card" id="identidad">
    <h2>üë§ Datos del jugador</h2>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
      <label>
        <div style="font-size:.9rem;opacity:.8">Nombre</div>
        <input id="playerName" type="text" placeholder="Tu nombre" required>
      </label>
      <label>
        <div style="font-size:.9rem;opacity:.8">√Årea</div>
        <input id="playerArea" type="text" placeholder="Producci√≥n / Mantenimiento / ...">
      </label>
      <button id="saveIdentity" class="primary">Guardar</button>
      <span id="idSaved" class="pill" style="display:none">‚úÖ Guardado</span>
    </div>
    <p class="pill" style="margin-top:8px;opacity:.8">Los datos se guardan en este dispositivo y se env√≠an con tu puntaje.</p>
  </section>

  <!-- MEMORAMA -->
  <section id="memoria" class="card" role="tabpanel">
    <h2>üÉè Memorama</h2>
    <div class="board" id="board"></div>
    <p><span class="pill">Movimientos: <span id="moves">0</span></span>
       <span class="pill">Aciertos: <span id="matches">0</span>/7</span></p>
    <button id="memReset" class="primary">Reiniciar</button>
    <p id="memMsg"></p>
  </section>

  <!-- DETECTA EL RIESGO -->
  <section id="riesgos" class="card" role="tabpanel" hidden>
    <h2>üöß Detecta el riesgo</h2>
    <div class="scene">
      <!-- Reemplaza la imagen por una tuya si quieres -->
      <img src="imagenes/escena_demo.png.jpg" alt="Escena de seguridad" usemap="#mapa-riesgos" width="900">

      <map name="mapa-riesgos">


<map name="mapa-riesgos">
  <!-- Aqu√≠ defines las zonas correctas o riesgos -->
  <area shape="circle" coords="734,136,67" alt="Zona 1"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="241,208,77" alt="Zona 2"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="165,43,56" alt="Zona 3"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="549,346,89" alt="Zona 4"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="467,201,67" alt="Zona 5"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="23,249,47" alt="Zona 6"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="625,164,57" alt="Zona 7"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="829,273,59" alt="Zona 8"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="131,303,56" alt="Zona 9"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="49,73,45" alt="Zona 10"
        data-control="‚ö† Riesgo">
        
  <area shape="circle" coords="530,29,53" alt="Zona 11"
        data-control="‚ö† Riesgo">
</map>

      
    </div>
    <div id="controlsBox"></div>
    <p><span class="pill">Aciertos: <span id="riskHits">0</span>/3</span></p>
  </section>

  <!-- TRIVIA -->
  <section id="trivia" class="card" role="tabpanel" hidden>
    <h2>‚ùì Trivia de seguridad</h2>
    <div id="quizBox"></div>
  </section>
</main>

<script>
  /* ===== Tabs ===== */
  const tabs=document.querySelectorAll('.tab');
  const panels=[...document.querySelectorAll('[role="tabpanel"]')];
  tabs.forEach(t=>t.onclick=()=>{
    tabs.forEach(x=>x.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    panels.forEach(p=>p.hidden=('#'+p.id)!==t.dataset.target);
  });

  /* ===== Identidad: nombre + √°rea (localStorage) ===== */
  function syncIdentityFromForm() {
    const name = (document.getElementById('playerName').value || '').trim();
    const area = (document.getElementById('playerArea').value || '').trim();
    if (!name) { alert('Por favor escribe tu nombre'); return false; }
    if (!area) { alert('Por favor escribe tu √°rea'); return false; }
    localStorage.setItem('player_name', name);
    localStorage.setItem('player_area', area);
    const tick = document.getElementById('idSaved');
    if (tick) { tick.style.display = 'inline-block'; setTimeout(()=> tick.style.display='none', 1500); }
    return true;
  }
  function populateIdentityForm() {
    document.getElementById('playerName').value = localStorage.getItem('player_name') || '';
    document.getElementById('playerArea').value = localStorage.getItem('player_area') || '';
  }
  function getPlayerInfo() {
    return {
      name: localStorage.getItem('player_name') || '',
      area: localStorage.getItem('player_area') || ''
    };
  }
  function ensureIdentity() {
    const who = getPlayerInfo();
    if (!who.name || !who.area) return syncIdentityFromForm();
    return true;
  }
  document.getElementById('saveIdentity').addEventListener('click', (e)=>{ e.preventDefault(); syncIdentityFromForm(); });
  document.addEventListener('DOMContentLoaded', populateIdentityForm);

  /*Memorama */
  (function(){
    const PAIRS=[
      ['<img src="imagenes/CORTINA.jpg" alt="CORTINA">','CORTINA'],
      ['<img src="imagenes/SECCIONADOR.jpg" alt="SECCIONADOR">','SECCIONADOR'],
      ['<img src="imagenes/GUARDA.jpg" alt="GUARDA">','GUARDA'],
      ['<img src="imagenes/INTERLOCK.jpg" alt="INTERLOCK">','INTERLOCK'],
      ['<img src="imagenes/2LLAVES.jpg" alt="2LLAVES">','2LLAVES'],
      ['<img src="imagenes/ENCLAVAMIENTO.jpg" alt="ENCLAVAMIENTO">','ENCLAVAMIENTO'],
      ['<img src="imagenes/RIESGO.jpg" alt="RIESGO">','RIESGO']
    ];
    const board=document.getElementById('board');
    const movesEl=document.getElementById('moves');
    const matchesEl=document.getElementById('matches');
    const msg=document.getElementById('memMsg');
    let first=null, second=null, lock=false, moves=0, matches=0;

    function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
    function setup(){
      board.innerHTML=''; moves=0; matches=0;
      movesEl.textContent='0'; matchesEl.textContent='0'; msg.textContent='';
      const data=shuffle([...PAIRS.map(p=>({t:'img',v:p[0],k:p[1]})),...PAIRS.map(p=>
        ({t:'txt',v:p[1],k:p[1]}))]);
      data.forEach(it=>{
        const t=document.createElement('div'); t.className='tile'; t.dataset.kind=it.t; t.dataset.key=it.k;
        t.innerHTML='<div class="face front"></div><div class="face back">'+(it.t==='img'?it.v:'<small>'+it.v+'</small>')+'</div>';
        t.onclick=()=>flip(t); board.appendChild(t);
      });
    }
    function samePair(a,b){return a.dataset.key===b.dataset.key && a.dataset.kind!==b.dataset.kind;}
    function flip(t){
      if(lock||t.classList.contains('flip')) return;
      t.classList.add('flip');
      if(!first){first=t;return;}
      second=t; lock=true; moves++; movesEl.textContent=moves;
      if(samePair(first,second)){
        matches++; matchesEl.textContent=matches;
        lock=false; first=null; second=null;
        if(matches===PAIRS.length){
          msg.textContent='üéâ ¬°Completado!';
          if (!ensureIdentity()) return;
          window.__onMemoramaFinish(moves,PAIRS.length);
        }
      } else {
        setTimeout(()=>{first.classList.remove('flip');second.classList.remove('flip');first=null;second=null;lock=false;},650);
      }
    }
    document.getElementById('memReset').onclick=setup;
    setup();
  })();

  /* ===== Detecta el riesgo ===== */
  (function(){
    const box=document.getElementById('controlsBox');
    const hitsEl=document.getElementById('riskHits');
    let hits=0;
    document.querySelectorAll('map[name="mapa-riesgos"] area').forEach(a=>{
      a.addEventListener('click',(e)=>{
        e.preventDefault();
        if(a.dataset.done) return;
        a.dataset.done='1'; hits++; hitsEl.textContent=hits;
        const p=document.createElement('p'); p.textContent='‚úî '+a.dataset.control; box.appendChild(p);
        if(hits>=3){
          if (!ensureIdentity()) return;
          window.__onRiesgosFinish(hits,3);
        }
      });
    });
  })();

  /* ===== Trivia ===== */
  (function(){
    const Q = [
  {q:"¬øQu√© se debe revisar en un paro de emergencia?", 
   o:["Que cuente con se√±alizaci√≥n y funcione correctamente",
      "Que est√© cubierto con un capuch√≥n",
      "Que se use para cualquier tipo de parada",
      "Que solo est√© en oficinas"], a:0},

  {q:"¬øCu√°l es la funci√≥n de un paro de emergencia?", 
   o:["Bloquear el acceso al operador",
      "Detener la m√°quina √∫nicamente en emergencias",
      "Sustituir las guardas de seguridad",
      "Apagar la luz de la planta"], a:1},

  {q:"¬øQu√© caracter√≠sticas debe cumplir una guarda fija?", 
   o:["Ser f√°cil de quitar con la mano",
      "Retirarse solo con herramienta y cubrir al 100% partes m√≥viles",
      "No requiere se√±alizaci√≥n",
      "Pueden estar flojas mientras protejan"], a:1},

  {q:"¬øQu√© significa que una guarda m√≥vil tenga 'interlock'?", 
   o:["Que puede abrirse sin detener la m√°quina",
      "Que solo el supervisor puede retirarla",
      "Que la m√°quina se detiene autom√°ticamente al abrirse",
      "Que se bloquea con un candado"], a:2},

  {q:"¬øQu√© dispositivos se consideran guardas con presencia?", 
   o:["Botones de arranque",
      "Cortinas de luz y tapetes de seguridad",
      "Manuales de operaci√≥n",
      "Se√±alizaciones de piso"], a:1},

  {q:"¬øCu√°l es el tama√±o m√°ximo de la abertura en una guarda tipo t√∫nel o sobre?", 
   o:["1 metro","80 cm","50 cm","No tiene l√≠mite"], a:2},

  {q:"¬øQu√© debe tener una guarda para evitar atrapamientos?", 
   o:["Pintura de color amarillo",
      "Se√±alizaci√≥n de riesgo",
      "Aperturas grandes",
      "Estar hecha de madera"], a:1},

  {q:"¬øQu√© se debe hacer con las lecciones aprendidas y SOPs?", 
   o:["Guardarlas en bodega",
      "Mantener acceso disponible para el personal",
      "Compartirlas solo en auditor√≠as",
      "No son necesarias"], a:1},

  {q:"¬øQu√© se revisa en la ejecuci√≥n de tareas en m√°quinas?", 
   o:["Que el trabajador pueda improvisar",
      "Que se siga un procedimiento seguro de intervenci√≥n",
      "Que el operador trabaje sin guantes",
      "Que no se usen paros de emergencia"], a:1},

  {q:"¬øPor qu√© es importante que las guardas est√©n fijas en su posici√≥n?", 
   o:["Para que se vean m√°s est√©ticas",
      "Para asegurar la protecci√≥n continua y evitar que se retiren f√°cilmente",
      "Para poder moverlas r√°pido cuando se requiera",
      "Para ahorrar en mantenimiento"], a:1}
];

    let i=0,score=0;
    const box=document.getElementById('quizBox');
    function render(){
      if(i>=Q.length){
        box.innerHTML=`<strong>üèÅ ¬°Fin!</strong> Aciertos: ${score}/${Q.length}`;
        if (!ensureIdentity()) return;
        window.__onTriviaFinish(score,Q.length);
        return;
      }
      const q=Q[i]; box.innerHTML=`<p>${q.q}</p>`;
      q.o.forEach((opt,idx)=>{
        const b=document.createElement('button'); b.className="primary";
        b.textContent=opt; b.onclick=()=>{ if(idx===q.a) score++; i++; render(); };
        box.appendChild(b);
      });
    }
    render();
  })();
</script>

<!-- ===== MARCADOR ONLINE (Google Sheets) ===== -->
<script>
  // Pega aqu√≠ el URL /exec de tu App Web de Apps Script:
  const SCORE_ENDPOINT = "https://script.google.com/macros/s/AKfycbwmEVXdDwRsmUJiy_CnLMZIDuQpeq7PkCv1k1ygmHG89QqqmFiKwwksdS2u73oMbmu4/exec";

  function toast(msg){const t=document.createElement("div");t.textContent=msg;
    Object.assign(t.style,{position:"fixed",left:"50%",bottom:"16px",transform:"translateX(-50%)",
    background:"#111827",color:"#e5e7eb",padding:"10px 14px",borderRadius:"10px",border:"1px solid #374151",zIndex:9999});
    document.body.appendChild(t);setTimeout(()=>t.remove(),2500);}
  function getDeviceId(){let id=localStorage.getItem("device_id");if(!id){id=(crypto.randomUUID?.()||(Date.now()+"-"+Math.random()));localStorage.setItem("device_id",id);}return id;}
  function getPlayerInfo(){return{ name:localStorage.getItem("player_name")||"", area:localStorage.getItem("player_area")||"" };}

  async function submitScore({ game, score, extra={} }){
    if(!SCORE_ENDPOINT || !SCORE_ENDPOINT.includes("/exec")){ toast("Configura SCORE_ENDPOINT"); return; }
    const who=getPlayerInfo();
    const payload={ name:who.name||"Jugador", area:who.area||"Otra", game, score:Number(score)||0, device_id:getDeviceId(), ...extra };
    try{
      await fetch(SCORE_ENDPOINT,{ method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload), mode:"no-cors" });
      toast("‚úÖ Puntaje enviado");
      console.log("Score enviado:", payload);
    }catch(e){ console.error(e); toast("‚ö†Ô∏è No se pudo enviar el puntaje"); }
  }

  // Ganchos que se llaman al terminar cada juego
  window.__onTriviaFinish=(score,total)=>submitScore({game:"trivia",score,extra:{total}});
  window.__onMemoramaFinish=(moves,pairs)=>{const pts=Math.max(1,(pairs*50)-moves);submitScore({game:"memorama",score:pts,extra:{moves,pairs}});}
  window.__onRiesgosFinish=(hits,needed)=>{const pts=hits>=needed?100:Math.round(100*(hits/needed));submitScore({game:"riesgos",score:pts,extra:{hits,needed}});}
</script>

<!-- (Opcional) Mini panel de diagn√≥stico: descomenta si lo necesitas
<script>
(function debugScores(){
  const box=document.createElement('div');
  Object.assign(box.style,{position:'fixed',left:'10px',bottom:'10px',padding:'10px 12px',background:'#0b1220',color:'#e5e7eb',border:'1px solid #374151',borderRadius:'10px',fontSize:'12px',zIndex:99999,maxWidth:'300px'});
  box.innerHTML = `
    <div style="font-weight:700;margin-bottom:6px">Debug marcador</div>
    <div>Endpoint: <code style="word-break:break-all">${(typeof SCORE_ENDPOINT!=='undefined'?SCORE_ENDPOINT:'(no definido)')}</code></div>
    <div id="dbgIdent" style="margin:6px 0"></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button id="dbgSet" style="padding:6px 10px;border-radius:8px;border:1px solid #374151;background:#1f2937;color:#e5e7eb">üë§ Cambiar nombre/√°rea</button>
      <button id="dbgSend" style="padding:6px 10px;border-radius:8px;border:1px solid #374151;background:#22c55e;color:#081016;font-weight:700">üöÄ Enviar prueba</button>
    </div>
    <div id="dbgMsg" style="margin-top:6px;opacity:.9"></div>`;
  document.body.appendChild(box);
  function getDeviceId(){ let id=localStorage.getItem('device_id'); if(!id){ id=(crypto.randomUUID?.()||(Date.now()+'-'+Math.random())); localStorage.setItem('device_id',id); } return id; }
  function renderIdent(){ const n=localStorage.getItem('player_name')||'(sin nombre)'; const a=localStorage.getItem('player_area')||'(sin √°rea)'; document.getElementById('dbgIdent').textContent=`üë§ ${n} ‚Äî üè∑Ô∏è ${a}`; }
  document.getElementById('dbgSet').onclick=()=>{ localStorage.removeItem('player_name'); localStorage.removeItem('player_area'); alert('Vuelve a llenar el formulario arriba.'); renderIdent(); };
  document.getElementById('dbgSend').onclick=async()=>{ const payload={ name:localStorage.getItem('player_name')||'Jugador', area:localStorage.getItem('player_area')||'Otra', game:'test', score:1, device_id:getDeviceId(), debug:true };
    document.getElementById('dbgMsg').textContent='Enviando‚Ä¶';
    try{ await fetch(SCORE_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),mode:'no-cors'}); document.getElementById('dbgMsg').textContent='‚úÖ Enviado. Revisa tu Google Sheet.'; }catch(e){ document.getElementById('dbgMsg').textContent='‚ùå Error al enviar'; console.error(e); }
  };
  renderIdent();
})();
</script>
-->
</body>
</html>
